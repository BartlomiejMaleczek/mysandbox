<apex:page standardController="Opportunity" showHeader="false" standardStylesheets="true" sidebar="false" docType="html-5.0">
    <head>
<!--        <script src="/soap/ajax/32.0/connection.js"></script>-->
<!--        <script src="https://rawgit.com/ternarylabs/porthole/master/src/porthole.min.js"></script>-->
<!--        <script src="/soap/ajax/32.0/connection.js"></script>-->
<!--        <apex:includeScript value="/soap/ajax/32.0/connection.js"/>-->
        <apex:includeScript value="https://rawgit.com/ternarylabs/porthole/master/src/porthole.min.js"/>
<!--        <apex:includeScript value="/resource/easyXDMConsumer"/>-->
<!--        <apex:includeScript value="{! $Resource.easyXDMConsumer }"/>-->
    </head>
<body style="background-color:#a8baa8;">

    <apex:form >
        <apex:commandButton id="buttonTest" value="Send Parent Refresh" onclick="sendRefresh(); return false;"/>&nbsp;
        <apex:commandButton value="Send Parent Edit" onclick="sendEdit(); return false;"/>&nbsp;
        <apex:commandButton value="Send Iframe Height" onclick="sendFrameSize(); return false;"/>&nbsp;
        <apex:inputText id="heightField" styleClass="heightField"/>
    </apex:form>

<!--    <script>-->
<!--        function SendMessage(message)-->
<!--        {-->
<!--            if (window.postMessage)-->
<!--                parent.postMessage(message, "*");-->
<!--        }-->

<!--        window.onload = function() {-->
<!--            // offsetHeight may or may not work in your browser,-->
<!--            // but there is plenty of documentation of alternatives-->
<!--            SendMessage(document.body.offsetHeight + 10 + "px");-->
<!--        }-->
<!--    </script>-->



</body>

    <script type="text/javascript" >
        <!--var test2 = sforce.connection.sessionId='{!GETSESSIONID()}';-->
        // console.log(test2);
        __oppty = {Id: "{!Opportunity.Id}"};
        var opptyid = __oppty.Id.length === 18? __oppty.Id.substring(0,15): __oppty.Id;
        __ProviderXDM = new Porthole.WindowProxy('https://bartlomiejmaleczek-dev-ed.my.salesforce.com/' + opptyid);
        __ProviderXDM.addEventListener( function(messageEvent) {
            if (messageEvent) {
                var msg = messageEvent.data;
                switch (msg.verb) {
                    case "test":
                        alert("XDM Test message recv'd by Provider");
                        break;
                    case "refresh":
                        location.reload();
                        break;
                }
            }
        });

        function sendRefresh() {
            __ProviderXDM.post({verb:"refresh"});
        }

        function sendEdit() {
            __ProviderXDM.post({verb:"edit"});
        }

        function sendFrameSize() {
            console.log('sendFrameSize');
            var field = document.getElementsByClassName("heightField")[0];
            console.log('field', field);
            //if no height is provided in the textfield, send a random height to show effect
            var height = field.value === ""? (100 + Math.floor(Math.random()*100)) : field.value;
            console.log('height ', height );
            var msg = {
                verb: "resize",
                payload: {
                    iframe:'XDMPage',
                    size: {
                        height: height
                    }
                }
            };
            console.log('msg', msg);
            var tets = __ProviderXDM.post(msg);
            console.log(tets);
        }

        var buttonGet = document.getElementsByClassName('heightField');
        console.log(buttonGet);
        document.getElementsByClassName("heightField")[0].value = 100;
        console.log( "Child Location:" );
        console.log( location.href );

    </script>
</apex:page>